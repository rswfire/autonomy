// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}


//
//  SIGNAL -- THE ATOMIC UNIT OF LIVED DATA
//

model Signal {

  signal_id           String   @id @default(cuid()) @db.VarChar(26)
  signal_type         String   @db.VarChar(50)
  signal_title        String   @db.VarChar(100)
  signal_description  String?  @db.Text
  signal_author       String   @db.VarChar(50)

  signal_location Unsupported("geography(Point, 4326)")? @map("signal_location")

  signal_status      String  @default("PENDING")
  signal_visibility  String  @default("PUBLIC")

  signal_metadata  Json?  @db.JsonB
  signal_payload   Json?  @db.JsonB
  signal_tags      Json?  @db.JsonB

  signal_embedding Unsupported("vector(1536)")?

  stamp_created   DateTime   @default(now())
  stamp_updated   DateTime?  @updatedAt
  stamp_imported  DateTime?  @default(now())

  synthesis    Synthesis[]      @relation("SynthesisToSignal")
  clusters     ClusterSignal[]

  @@map("signals")
  @@index([signal_type],       map: "idx_signal-type")
  @@index([signal_title],      map: "idx_signal-title")
  @@index([signal_author],     map: "idx_signal-author")
  @@index([signal_status],     map: "idx_signal-status")
  @@index([signal_visibility], map: "idx_signal-visibility")
  
  
  
  @@index([stamp_created],     map: "idx_signal_stamp-created")
  @@index([stamp_imported],    map: "idx_signal_stamp-imported")

}


//
// CLUSTER - STRUCTURED GROUPING OF RELATED SIGNALS
//

model Cluster {

  cluster_id     String  @id @default(cuid()) @db.VarChar(26)
  cluster_type   String  @db.VarChar(50)
  cluster_title  String  @db.VarChar(100)
  cluster_depth  Int     @default(0)

  cluster_annotations  Json?   @db.JsonB
  cluster_metadata     Json?   @db.JsonB
  cluster_payload      Json?   @db.JsonB
  cluster_tags         Json?   @db.JsonB
  cluster_state        String  @db.VarChar(50)

  cluster_embedding Unsupported("vector(1536)")?

  stamp_cluster_start DateTime?
  stamp_cluster_end   DateTime?
  stamp_created       DateTime  @default(now())

  parent_cluster_id  String?    @db.VarChar(26)
  parent_cluster     Cluster?   @relation("ClusterHierarchy", fields: [parent_cluster_id], references: [cluster_id])
  child_clusters     Cluster[]  @relation("ClusterHierarchy")

  signals    ClusterSignal[]
  synthesis  Synthesis[] @relation("SynthesisToCluster")

  @@map("clusters")
  @@index([cluster_type], map: "idx_cluster_cluster-type")
  @@index([cluster_title], map: "idx_cluster_cluster-title")
  @@index([cluster_depth], map: "idx_cluster_cluster-depth")
  @@index([cluster_state], map: "idx_cluster_cluster-state")
  @@index([stamp_cluster_start], map: "idx_cluster_stamp-cluster-start")
  @@index([stamp_cluster_end], map: "idx_cluster_stamp-cluster-end")
  @@index([stamp_cluster_start, stamp_cluster_end], map: "idx_cluster_stamp-cluster-start_cluster_stamp-cluster-end")
  @@index([parent_cluster_id], map: "idx_cluster_parent-cluster-id")

}

model ClusterSignal {

  cluster_id  String  @default(cuid()) @db.VarChar(26)
  signal_id   String  @default(cuid()) @db.VarChar(26)

  cluster  Cluster  @relation(fields: [cluster_id], references: [cluster_id], onDelete: Cascade)
  signal   Signal   @relation(fields: [signal_id], references: [signal_id], onDelete: Cascade)

  pivot_position  Int?
  pivot_metadata  Json?     @db.JsonB
  stamp_added     DateTime  @default(now())

  @@id([cluster_id, signal_id])
  @@map("clusters_signals")
  @@index([cluster_id], map: "idx_clustersignal_cluster-id")
  @@index([signal_id], map: "idx_clustersignal_signal-id")

}


//
// SYNTHESIS -- AI EXTRACTION LAYER
//

model Synthesis {

  synthesis_id       String   @id @default(cuid()) @db.VarChar(26)
  synthesis_type     String   @db.VarChar(50)  // METADATA | REFLECTION
  synthesis_subtype  String   @db.VarChar(50)  // SURFACE, STRUCTURE, PATTERNS | MIRROR, MYTH, NARRATIVE
  synthesis_source   String?  @db.VarChar(100)
  synthesis_depth    Int      @default(0)

  polymorphic_id    String  @default(cuid()) @db.VarChar(26)
  polymorphic_type  String  @db.VarChar(50)

  signal   Signal?   @relation("SynthesisToSignal", fields: [polymorphic_id], references: [signal_id], onDelete: Cascade, map: "fkey_synthesis_signal-id")
  cluster  Cluster?  @relation("SynthesisToCluster", fields: [polymorphic_id], references: [cluster_id], onDelete: Cascade, map: "fkey_synthesis_cluster-id")

  synthesis_annotations  Json?  @db.JsonB
  synthesis_history      Json?  @db.JsonB
  synthesis_errors       Json?  @db.JsonB
  synthesis_content      Json?  @db.JsonB

  synthesis_embedding Unsupported("vector(1536)")?

  stamp_created  DateTime   @default(now())
  stamp_updated  DateTime?  @updatedAt

  @@map("synthesis")
  @@index([synthesis_type], map: "idx_synthesis_synthesis-type")
  @@index([synthesis_subtype], map: "idx_synthesis_synthesis-subtype")
  @@index([synthesis_type, synthesis_subtype], map: "idx_synthesis_synthesis-type_synthesis-subtype")
  @@index([synthesis_source], map: "idx_synthesis_synthesis-source")
  @@index([polymorphic_id], map: "idx_synthesis_polymorphic-id")
  @@index([polymorphic_type], map: "idx_synthesis_polymorphic-type")
  @@index([polymorphic_id, polymorphic_type], map: "idx_synthesis_polymorphic-id_synthesis_polymorphic-type")
  @@index([stamp_created], map: "idx_synthesis_stamp_created")

}


//
// USER
//

model User {
  user_id        String   @id @default(cuid()) @db.VarChar(26)
  user_email     String   @unique
  user_name      String?
  user_password  String   @db.VarChar(255)  // Hashed password

  // Privilege levels
  user_role      String   @default("GUEST") @db.VarChar(20)  // OWNER | SANCTUM | GUEST

  // Ownership tracking
  is_owner       Boolean  @default(false)

  stamp_created  DateTime   @default(now())
  stamp_updated  DateTime?  @updatedAt

  @@map("users")
  @@index([user_email], map: "idx_user_user-email")
  @@index([user_name], map: "idx_user_user-name")
  @@index([user_role], map: "idx_user_user-role")
  @@index([is_owner], map: "idx_user_is-owner")
  @@index([stamp_created], map: "idx_user_stamp-created")
}
